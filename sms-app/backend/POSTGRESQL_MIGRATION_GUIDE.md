# PostgreSQL Migration Guide for SMS Maintenance Portal

## Overview
This guide covers migrating the SMS Maintenance Portal from SQLite to PostgreSQL for production deployment.

## Why PostgreSQL?
- **Concurrent Connections**: SQLite locks the entire database for writes
- **Scalability**: PostgreSQL handles thousands of concurrent users
- **Performance**: Better query optimization and indexing
- **Reliability**: ACID compliance with proper transaction support
- **Production Ready**: Industry standard for production applications

## Quick Start

### 1. Install PostgreSQL

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
```

**macOS:**
```bash
brew install postgresql
brew services start postgresql
```

**Windows:**
Download installer from https://www.postgresql.org/download/windows/

### 2. Run Setup Script
```bash
cd sms-app/backend
npm install
npm run db:setup
```

This will:
- Create database and user
- Run schema migrations
- Verify the setup

### 3. Migrate Existing Data (Optional)
If you have existing data in SQLite:
```bash
npm run migrate:sqlite-to-postgres
```

### 4. Update Environment
The setup script will update your `.env` file. Verify it contains:
```env
DATABASE_TYPE=postgresql
DATABASE_URL=postgresql://sms_user:sms_pass@localhost:5432/sms_db
```

## Manual Setup (Alternative)

### 1. Create Database and User
```sql
-- Connect as postgres superuser
sudo -u postgres psql

-- Create user and database
CREATE USER sms_user WITH PASSWORD 'sms_pass';
CREATE DATABASE sms_db OWNER sms_user;
GRANT ALL PRIVILEGES ON DATABASE sms_db TO sms_user;
\q
```

### 2. Run Migrations
```bash
psql -U sms_user -d sms_db -f src/migrations/001_create_postgresql_schema.sql
```

### 3. Configure Application
Update `.env`:
```env
DATABASE_TYPE=postgresql
DATABASE_URL=postgresql://sms_user:sms_pass@localhost:5432/sms_db
```

## Key Changes from SQLite

### 1. Boolean Values
- SQLite: 0/1
- PostgreSQL: true/false

### 2. Auto-increment
- SQLite: `AUTOINCREMENT`
- PostgreSQL: `SERIAL` or `GENERATED BY DEFAULT AS IDENTITY`

### 3. Date/Time
- SQLite: TEXT as ISO8601
- PostgreSQL: `TIMESTAMPTZ` (timezone-aware)

### 4. Full-text Search
- SQLite: FTS5 virtual tables
- PostgreSQL: Native full-text search with GIN indexes

## Production Configuration

### 1. Connection Pooling
Already configured in `database.postgres.ts`:
```javascript
max: 20,                    // Maximum connections
idleTimeoutMillis: 30000,   // Idle timeout
connectionTimeoutMillis: 2000 // Connection timeout
```

### 2. SSL Configuration
For production, use SSL:
```env
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require
```

### 3. Performance Tuning
Edit `postgresql.conf`:
```conf
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB
```

## Backup Strategy

### Daily Backups
```bash
# Add to crontab
0 2 * * * pg_dump -U sms_user sms_db | gzip > /backup/sms_$(date +\%Y\%m\%d).sql.gz
```

### Restore from Backup
```bash
gunzip < backup.sql.gz | psql -U sms_user sms_db
```

## Monitoring

### Check Active Connections
```sql
SELECT count(*) FROM pg_stat_activity;
```

### Check Database Size
```sql
SELECT pg_database_size('sms_db');
```

### Slow Query Log
```sql
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;
```

## Troubleshooting

### Connection Refused
1. Check PostgreSQL is running: `systemctl status postgresql`
2. Check `pg_hba.conf` allows your connection method
3. Verify firewall rules

### Permission Denied
```sql
GRANT ALL ON ALL TABLES IN SCHEMA public TO sms_user;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO sms_user;
```

### Performance Issues
1. Run `ANALYZE` to update statistics
2. Check for missing indexes
3. Review connection pool settings

## Security Considerations

1. **Never use default passwords in production**
2. **Use SSL/TLS for remote connections**
3. **Restrict connections in pg_hba.conf**
4. **Keep the 20% markup calculations server-side only**
5. **Regular security updates**

## Next Steps

After successful migration:
1. Test all features thoroughly
2. Set up automated backups
3. Configure monitoring
4. Plan for high availability (replica)
5. Set up connection pooling with PgBouncer for large scale

## Support

For issues with the migration:
1. Check logs: `/var/log/postgresql/`
2. Review this guide
3. Check PostgreSQL documentation
4. Contact the SMS development team